version: '3.8'

services:
  # 1. The Legacy Host ("Server")
  mission-host:
    image: python:3.8-slim
    container_name: mission-host
    hostname: mission-host
    command: /usr/sbin/sshd -D
    ports:
      - "2222:22" # Allow local SSH if needed
    environment:
      - DEBIAN_FRONTEND=noninteractive
    volumes:
      - ./setup_host.sh:/entrypoint-init/setup.sh
      - ../../:/mission:ro # Mount tools read-only for setup usage
      - ../../:/repos/srl0/srlinux/.mission:rw # Mock the remote mission root
    # We install SSH and build tools to simulate a legacy dev server
    build:
      context: .
      dockerfile_inline: |
        FROM python:3.8-slim
        # Simulate missing pip environment
        RUN pip uninstall -y pip setuptools wheel 2>/dev/null || true && rm -rf /usr/local/lib/python3.8/ensurepip
        RUN apt-get update && apt-get install -y openssh-server rsync git build-essential vim tmux sudo curl
        RUN mkdir -p /var/run/sshd
        # User 'oracle' with password 'oracle'
        RUN if ! id -u oracle > /dev/null 2>&1; then useradd -m -s /bin/bash -p $(python3 -c 'import crypt; print(crypt.crypt("oracle", crypt.mksalt(crypt.METHOD_SHA512)))') oracle; fi
        RUN echo "oracle ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
        # SSH Keys setup (allow key auth)
        RUN mkdir -p /home/oracle/.ssh && chmod 700 /home/oracle/.ssh && chown oracle:oracle /home/oracle/.ssh
    healthcheck:
      test: ["CMD", "service", "ssh", "status"]
      interval: 5s
      timeout: 10s
      retries: 5

  # 2. The Client ("Laptop")
  mission-client:
    image: python:3.11-slim
    container_name: mission-client
    hostname: mission-client
    command: tail -f /dev/null # Keep alive
    depends_on:
      - mission-host
    environment:
      - MISSION_HOST=mission-host
    volumes:
      # Mount the Mission Pack source so we can develop tools locally
      - ../../:/mission:z 
    working_dir: /mission
    # Install client tools (ssh, rsync)
    build:
      context: .
      dockerfile_inline: |
        FROM python:3.11-slim
        RUN apt-get update && apt-get install -y openssh-client rsync git vim tmux
        RUN id -u neo &>/dev/null || useradd -m -s /bin/bash neo
