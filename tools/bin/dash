#!/bin/bash
SESSION="mission-control"
BIN_DIR="$(cd "$(dirname "$0")" && pwd)"
TOOLS_DIR="$(dirname "$BIN_DIR")"
MISSION_DIR="$(dirname "$TOOLS_DIR")"
PROJECT_ROOT="$(dirname "$MISSION_DIR")"
MONITOR_CMD="${MISSION_MONITOR:-/bin/bash}"

tmux kill-session -t "$SESSION" 2>/dev/null || true

echo "üöÄ Initializing Mission Control..."
echo "üìç Context: $PROJECT_ROOT"

tmux new-session -d -s "$SESSION" -n "Mission" -c "$PROJECT_ROOT"
tmux split-window -h -t "$SESSION:Mission.0" -p 66 -c "$PROJECT_ROOT"
tmux split-window -h -t "$SESSION:Mission.1" -p 50 -c "$PROJECT_ROOT"
tmux split-window -v -t "$SESSION:Mission.2" -p 50 -c "$PROJECT_ROOT"

# Pane 0: Architect (Agent)
tmux send-keys -t "$SESSION:Mission.0" "clear; '$BIN_DIR/architect'" C-m

# Pane 1: Coder (Agent)
tmux send-keys -t "$SESSION:Mission.1" "clear; '$BIN_DIR/coder'" C-m

# Pane 2: Shell (Human/Container)
# CHANGED: Now launches the hermetic shell instead of just echoing
tmux send-keys -t "$SESSION:Mission.2" "clear; '$BIN_DIR/shell'" C-m

# Pane 3: Monitor (Host/Logs)
tmux send-keys -t "$SESSION:Mission.3" "echo '--- üî≠ Monitor ---'; $MONITOR_CMD" C-m

tmux select-pane -t "$SESSION:Mission.1"
exec tmux attach-session -t "$SESSION"
