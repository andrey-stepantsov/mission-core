#!/bin/bash
SESSION="hybrid-swarm"
DIR=$(dirname "$(readlink -f "$0")")
TOOLS_BIN=$(cd "$DIR" && pwd)
cd "$(dirname "$DIR")/../.."

# 1. Hard Kill Old Session
tmux kill-session -t "$SESSION" 2>/dev/null

printf "ðŸš€ Launching Swarm (Tiled Layout)...\n"

# 2. Create Session (Pane 0)
tmux new-session -d -s "$SESSION" -n "HQ"

# 3. Create 4 Panes first (Force Tiled)
tmux split-window -h   # Split to 2
tmux split-window -v   # Split Right to 2
tmux select-pane -t 0
tmux split-window -v   # Split Left to 2
tmux select-layout tiled

# Now we have 4 panes. We target them by approximate position.
# Pane 0: Top Left
# Pane 1: Bottom Left
# Pane 2: Top Right
# Pane 3: Bottom Right

# PANE 0: Director (Top Left)
tmux select-pane -t 0
tmux send-keys "clear; .mission/tools/bin/director" C-m
tmux select-pane -T "Director (Strategy)"

# PANE 1: Toolsmith (Bottom Left)
tmux select-pane -t 1
tmux send-keys "clear; .mission/tools/bin/toolsmith_local" C-m
tmux select-pane -T "Toolsmith (Ops)"

# PANE 2: Coder (Top Right)
tmux select-pane -t 2
tmux send-keys "clear; .mission/tools/bin/coder" C-m
tmux select-pane -T "Coder (Docker)"

# PANE 3: Command (Bottom Right)
tmux select-pane -t 3
tmux send-keys "export PATH=\$PATH:$TOOLS_BIN" C-m
tmux send-keys "clear" C-m
tmux send-keys "echo 'ðŸŽ™ï¸ Control Plane Online'" C-m
tmux send-keys "echo '   tx \"msg\"      -> Send Request'" C-m
tmux send-keys "echo '   rx            -> Watch Log'" C-m
tmux select-pane -T "Command (You)"

# 4. Attach
tmux select-pane -t 3
exec tmux attach-session -t "$SESSION"
