#!/bin/bash
set -e

# Usage: ./provision_remote <user@host> [remote_root]
TARGET=$1
REMOTE_ROOT=${2:-"/repos/chaos"}

if [ -z "$TARGET" ]; then
    echo "Usage: $0 <user@host> [remote_root]"
    exit 1
fi

echo "ðŸš€ Provisioning $TARGET at $REMOTE_ROOT..."

# 1. Create Directories & Git Init
echo "   ðŸ“‚ Preparing directory structure..."
ssh -o StrictHostKeyChecking=no "$TARGET" "
    mkdir -p $REMOTE_ROOT
    cd $REMOTE_ROOT
    if [ ! -d .git ]; then git init; echo '# Provisioned Project' > README.md; fi
"

# 2. Side-Load Mission
echo "   ðŸ”§ Installing Mission Toolchain..."
ssh -o StrictHostKeyChecking=no "$TARGET" "
    cd $REMOTE_ROOT
    if [ ! -d .mission ]; then 
        git clone git@github.com:andrey-stepantsov/mission-core.git .mission
    else
        cd .mission && git pull
    fi
    # Checkout the branch with fixes
    cd .mission && git checkout diag/remote-test
"

# 3. Install DDD
echo "   ðŸ—  Installing DDD (Dead Drop Daemon)..."
ssh -o StrictHostKeyChecking=no "$TARGET" "
    cd $REMOTE_ROOT
    rm -rf .mission/tools/ddd 2>/dev/null
    git clone https://github.com/andrey-stepantsov/ddd .mission/tools/ddd
    
    mkdir -p .ddd/run
"

# 4. Configure DDD
echo "   âš™ï¸  Configuring DDD..."
# We interpret the JSON in the here-doc locally, so we escape quotes carefully or use single quotes for the whole block
ssh -o StrictHostKeyChecking=no "$TARGET" "
    cd $REMOTE_ROOT
    cat > .ddd/config.json <<EOF
{
  \"targets\": {
    \"dev\": {
      \"build\": {
        \"cmd\": \"make\",
        \"filter\": [\"raw\"]
      }
    }
  }
}
EOF
    # Dummy Makefile for testing
    echo \"all:; @echo 'Simulated Build Success'\" > Makefile
"

    # 5. Bootstrap & Verify
echo "   âœ… Verifying Environment..."
ssh -o StrictHostKeyChecking=no "$TARGET" "
    cd $REMOTE_ROOT
    chmod +x .mission/bin/remote-test.sh
    .mission/bin/remote-test.sh
"

echo "âœ¨ Provisioning Complete! You can now run:"
echo "   .mission/tools/bin/projector init $TARGET --remote-root $REMOTE_ROOT"
