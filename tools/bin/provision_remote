#!/bin/bash
set -e

# Defaults
USER="oracle"
HOST="mission-host" # Default internal docker name, but can be IP
PORT="22"
ALIAS="mission-dev"
REMOTE_ROOT="/repos/projects/project0"

# Parse Args
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -u|--user) USER="$2"; shift ;;
        -h|--host|--hostname) HOST="$2"; shift ;;
        -p|--port) PORT="$2"; shift ;;
        -a|--alias) ALIAS="$2"; shift ;;
        -d|--dir|--mount-dir|--remote-root) REMOTE_ROOT="$2"; shift ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

echo "üöÄ Configuring Remote Host: $ALIAS"
echo "   Host: $HOST ($PORT)"
echo "   User: $USER"
echo "   Remote Root: $REMOTE_ROOT"

# 1. SSH Key Setup (The Authentication)
echo "üîë Setting up SSH authentication..."
if [ ! -f ~/.ssh/id_rsa ]; then
    echo "   Generating authentication keypair..."
    ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""
fi
PUBKEY=$(cat ~/.ssh/id_rsa.pub)

# Try initial connection to copy ID
# We assume the user can log in via password or already has access. 
# This simplistic approach works for the sim (docker exec) but for real host usually requires ssh-copy-id
if [ "$HOST" == "mission-host" ]; then
    # Simulation shortcut
    echo "   Injecting authorized_key into container ($HOST)..."
    docker exec "$HOST" bash -c "mkdir -p /home/$USER/.ssh && echo '$PUBKEY' >> /home/$USER/.ssh/authorized_keys && chown $USER:$USER /home/$USER/.ssh/authorized_keys && chmod 600 /home/$USER/.ssh/authorized_keys"
else
    # Real Host Best Effort
    echo "   Attempting ssh-copy-id (You may be prompted for password)..."
    ssh-copy-id -p $PORT -i ~/.ssh/id_rsa.pub $USER@$HOST || echo "‚ö†Ô∏è  ssh-copy-id failed. Ensure you can access $USER@$HOST manually."
fi

# 2. SSH Config Alias
echo "üîå Verifying SSH connectivity..."
ALIAS_NAME="$ALIAS"
if ! grep -q "Host $ALIAS_NAME" ~/.ssh/config; then
    echo "   Adding '$ALIAS_NAME' alias to ~/.ssh/config..."
    cat >> ~/.ssh/config <<EOF

Host $ALIAS_NAME
    HostName $HOST
    User $USER
    Port $PORT
    IdentityFile ~/.ssh/id_rsa
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
EOF
else
    echo "   SSH config alias '$ALIAS_NAME' already exists."
fi

# 3. Provisioning (User Space Only)
echo "üß† Provisioning & Launching Tower..."

# Deploy Mission Tools via Git
echo "   Deploying Mission Tools via Git..."
BRANCH=$(git branch --show-current)
REPO_URL="https://github.com/andrey-stepantsov/mission-core"

ssh $ALIAS_NAME "if [ -d /home/$USER/.mission/.git ]; then
    echo '   Updating existing .mission repo...'
    cd /home/$USER/.mission && git fetch origin && git checkout $BRANCH && git pull origin $BRANCH
else
    echo '   Cloning .mission repo...'
    git clone -b $BRANCH $REPO_URL /home/$USER/.mission
fi"

# Deploy DDD Tool
echo "   Deploying DDD..."
DDD_REPO_URL="https://github.com/andrey-stepantsov/ddd"
ssh $ALIAS_NAME "if [ -d /home/$USER/.mission/tools/ddd/.git ]; then
    echo '   Updating existing DDD repo...'
    cd /home/$USER/.mission/tools/ddd && git fetch origin && git pull origin main
else
    echo '   Cloning DDD repo...'
    # If the directory exists but is not a git repo (e.g. empty folder from parent), remove it
    if [ -d /home/$USER/.mission/tools/ddd ]; then
        rm -rf /home/$USER/.mission/tools/ddd
    fi
    # Ensure parent dir exists
    mkdir -p /home/$USER/.mission/tools
    git clone $DDD_REPO_URL /home/$USER/.mission/tools/ddd
fi"

# Check for Required System Dependencies (No Root Install)
echo "   Verifying Remote Environment..."
ssh $ALIAS_NAME "
FAILED=0
# Check Bear
if ! command -v bear &> /dev/null; then
    echo '‚ö†Ô∏è  WARNING: \"bear\" not found in PATH. Real compilation DB generation will fail.'
    echo '   Please install bear (or equivalent) manually or confirm it is in your PATH.'
    FAILED=1
fi
# Check Clang
if ! command -v clang &> /dev/null; then
    echo '‚ö†Ô∏è  WARNING: \"clang\" not found in PATH.'
    echo '   Clang is recommended for implicit dependency scanning.'
    FAILED=1
fi
# Check Python3
if ! command -v python3 &> /dev/null; then
    echo '‚ùå ERROR: \"python3\" is required.'
    exit 1
fi
if [ \$FAILED -eq 1 ]; then
    echo '‚ö†Ô∏è  Proceeding with limited functionality...'
else
    echo '‚úÖ Environment looks good.'
fi
"

# Install Python Dependencies (User Space)
echo "   Installing Python Dependencies..."
# We use pip install --user via the bootstrap wrapper to ensure we target the correct venv
ssh $ALIAS_NAME "
    if [ -f /home/$USER/.mission/tools/ddd/requirements.txt ]; then
        /home/$USER/.mission/tools/lib/bootstrap.sh -m pip install -r /home/$USER/.mission/tools/ddd/requirements.txt
    else
        echo '‚ö†Ô∏è  DDD requirements.txt not found.'
    fi
"

# Launch Tower if not running
# launch_tower script handles tmux session creation idempotently
echo "   Checking/Launching Tower..."
ssh $ALIAS_NAME "PROJECT_ROOT=$REMOTE_ROOT /home/$USER/.mission/tools/bin/launch_tower"

echo "‚úÖ Configuration Complete!"
echo "   You can now initialize a project:"
echo "   Tools: $SCRIPT_DIR/projector"
echo "   Command: $SCRIPT_DIR/projector init $ALIAS_NAME --remote-root $REMOTE_ROOT"
