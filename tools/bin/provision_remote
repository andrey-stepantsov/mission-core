#!/bin/bash
set -e

# Defaults
USER="oracle"
HOST="mission-host" 
REMOTE_ROOT="/repos/projects/project0"

# Parse Args
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -u|--user) USER="$2"; shift ;;
        -d|--dir|--mount-dir|--remote-root) REMOTE_ROOT="$2"; shift ;;
        -h|--host) HOST="$2"; shift ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

echo "ðŸš€ Configuring Simulated Remote Host: $HOST"
echo "   User: $USER"
echo "   Remote Root: $REMOTE_ROOT"

# 1. SSH Key Setup (The Authentication)
echo "ðŸ”‘ Setting up SSH authentication..."
if [ ! -f ~/.ssh/id_rsa ]; then
    echo "   Generating authentication keypair..."
    ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""
fi
PUBKEY=$(cat ~/.ssh/id_rsa.pub)

echo "   Injecting authorized_key into container ($HOST)..."
docker exec "$HOST" bash -c "mkdir -p /home/$USER/.ssh && echo '$PUBKEY' >> /home/$USER/.ssh/authorized_keys && chown $USER:$USER /home/$USER/.ssh/authorized_keys && chmod 600 /home/$USER/.ssh/authorized_keys"

# 2. SSH Config Alias
echo "ðŸ”Œ Verifying SSH connectivity..."
ALIAS_NAME="mission-sim"
if ! grep -q "Host $ALIAS_NAME" ~/.ssh/config; then
    echo "   Adding '$ALIAS_NAME' alias to ~/.ssh/config..."
    cat >> ~/.ssh/config <<EOF

Host $ALIAS_NAME
    HostName localhost
    User $USER
    Port 2222
    IdentityFile ~/.ssh/id_rsa
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
EOF
else
    echo "   SSH config alias '$ALIAS_NAME' already exists."
fi

# 3. Sync Tools & Launch Tower (The Persistent Brain)
echo "ðŸ§  Provisioning & Launching Tower..."
# Note: We assume the host is already setup via setup_realistic_host.sh regarding directory structure.
# But we need to make sure the user has access to the tools.
# sync tools again just in case? setup_realistic_host.sh does it. 
# But let's assume this script might be run independently.

SCRIPT_DIR="$(dirname "$0")"
MISSION_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)" 

# Deploy tools to user home for consistent access (if not already there)
rsync -az -e "ssh" \
    --exclude '.git' \
    --exclude 'logs' \
    "$MISSION_ROOT/.mission/" \
    "$ALIAS_NAME:/home/$USER/.mission/"

# Launch Tower if not running
# launch_tower script handles tmux session creation idempotently
echo "   Checking/Launching Tower..."
ssh $ALIAS_NAME "PROJECT_ROOT=$REMOTE_ROOT /home/$USER/.mission/tools/bin/launch_tower"

echo "âœ… Configuration Complete!"
echo "   You can now initialize a project:"
echo "   Tools: $SCRIPT_DIR/projector"
echo "   Command: $SCRIPT_DIR/projector init $ALIAS_NAME --remote-root $REMOTE_ROOT"
