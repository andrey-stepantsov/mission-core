#!/bin/bash
set -e

# Defaults
USER="oracle"
HOST="mission-host" # Default internal docker name, but can be IP
PORT="2222"
ALIAS="mission-dev"
REMOTE_ROOT="/repos/projects/project0"

# Parse Args
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -u|--user) USER="$2"; shift ;;
        -h|--host|--hostname) HOST="$2"; shift ;;
        -p|--port) PORT="$2"; shift ;;
        -a|--alias) ALIAS="$2"; shift ;;
        -d|--dir|--mount-dir|--remote-root) REMOTE_ROOT="$2"; shift ;;
        *) echo "Unknown parameter passed: $1"; exit 1 ;;
    esac
    shift
done

echo "ðŸš€ Configuring Remote Host: $ALIAS"
echo "   Host: $HOST ($PORT)"
echo "   User: $USER"
echo "   Remote Root: $REMOTE_ROOT"

# 1. SSH Key Setup (The Authentication)
echo "ðŸ”‘ Setting up SSH authentication..."
if [ ! -f ~/.ssh/id_rsa ]; then
    echo "   Generating authentication keypair..."
    ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""
fi
PUBKEY=$(cat ~/.ssh/id_rsa.pub)

# Try initial connection to copy ID
# We assume the user can log in via password or already has access. 
# This simplistic approach works for the sim (docker exec) but for real host usually requires ssh-copy-id
if [ "$HOST" == "mission-host" ]; then
    # Simulation shortcut
    echo "   Injecting authorized_key into container ($HOST)..."
    docker exec "$HOST" bash -c "mkdir -p /home/$USER/.ssh && echo '$PUBKEY' >> /home/$USER/.ssh/authorized_keys && chown $USER:$USER /home/$USER/.ssh/authorized_keys && chmod 600 /home/$USER/.ssh/authorized_keys"
else
    # Real Host Best Effort
    echo "   Attempting ssh-copy-id (You may be prompted for password)..."
    ssh-copy-id -p $PORT -i ~/.ssh/id_rsa.pub $USER@$HOST || echo "âš ï¸  ssh-copy-id failed. Ensure you can access $USER@$HOST manually."
fi

# 2. SSH Config Alias
echo "ðŸ”Œ Verifying SSH connectivity..."
ALIAS_NAME="$ALIAS"
if ! grep -q "Host $ALIAS_NAME" ~/.ssh/config; then
    echo "   Adding '$ALIAS_NAME' alias to ~/.ssh/config..."
    cat >> ~/.ssh/config <<EOF

Host $ALIAS_NAME
    HostName $HOST
    User $USER
    Port $PORT
    IdentityFile ~/.ssh/id_rsa
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
EOF
else
    echo "   SSH config alias '$ALIAS_NAME' already exists."
fi

# 3. Sync Tools & Launch Tower (The Persistent Brain)
echo "ðŸ§  Provisioning & Launching Tower..."
# Note: We assume the host is already setup via setup_realistic_host.sh regarding directory structure.
# But we need to make sure the user has access to the tools.
# sync tools again just in case? setup_realistic_host.sh does it. 
# But let's assume this script might be run independently.

SCRIPT_DIR="$(dirname "$0")"
MISSION_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)" 

# Deploy tools via Git
echo "   Deploying Mission Tools via Git..."
BRANCH=$(git branch --show-current)
REPO_URL="https://github.com/andrey-stepantsov/mission-core"

# Check if repo exists, if so pull, else clone
ssh $ALIAS_NAME "if [ -d /home/$USER/.mission ]; then
    echo '   Updating existing .mission repo...'
    cd /home/$USER/.mission && git fetch origin && git checkout $BRANCH && git pull origin $BRANCH
else
    echo '   Cloning .mission repo...'
    git clone -b $BRANCH $REPO_URL /home/$USER/.mission
fi"

# Deploy DDD Tool
echo "   Deploying DDD..."
DDD_REPO_URL="https://github.com/andrey-stepantsov/ddd"
ssh $ALIAS_NAME "if [ -d /home/$USER/.mission/tools/ddd/.git ]; then
    echo '   Updating existing DDD repo...'
    cd /home/$USER/.mission/tools/ddd && git fetch origin && git pull origin main
else
    echo '   Cloning DDD repo...'
    # If the directory exists but is not a git repo (e.g. empty folder from parent), remove it
    if [ -d /home/$USER/.mission/tools/ddd ]; then
        rm -rf /home/$USER/.mission/tools/ddd
    fi
    # Ensure parent dir exists
    mkdir -p /home/$USER/.mission/tools
    git clone $DDD_REPO_URL /home/$USER/.mission/tools/ddd
fi"

# Install Remote Brain Dependencies
echo "   Installing Remote Brain Dependencies (Root Access Required)..."
# We assume the user has sudo rights or we use a separate root provisioning step.
# For the simulation 'oracle' user, we usually have sudo.
ssh $ALIAS_NAME "sudo apt-get update && sudo apt-get install -y bear clang build-essential python3-pip python3-venv"

# Install Python Deps for DDD
echo "   Installing Python Dependencies..."
ssh $ALIAS_NAME "pip3 install -r /home/$USER/.mission/tools/ddd/requirements.txt"

# Launch Tower if not running
# launch_tower script handles tmux session creation idempotently
echo "   Checking/Launching Tower..."
ssh $ALIAS_NAME "PROJECT_ROOT=$REMOTE_ROOT /home/$USER/.mission/tools/bin/launch_tower"

echo "âœ… Configuration Complete!"
echo "   You can now initialize a project:"
echo "   Tools: $SCRIPT_DIR/projector"
echo "   Command: $SCRIPT_DIR/projector init $ALIAS_NAME --remote-root $REMOTE_ROOT"
