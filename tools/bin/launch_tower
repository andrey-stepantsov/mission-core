#!/bin/bash
# launch_tower: Ensures the Mission Tower (tmux) is running with the Watcher
#
# Usage: ./launch_tower
#
# 1. Checks for 'mission_tower' session.
# 2. If missing, creates it and launches 'dd-daemon'.
# 3. If running via SSH payload, it just starts it.

SESSION="mission_tower"
BIN_DIR="$(dirname "$0")"
# Always use the local Lite daemon from this directory
DAEMON="$BIN_DIR/dd-daemon"

# Calculate Project Root (Assuming this script is in .mission/tools/bin)
# ../../../  -> Project Root
if [ -z "$PROJECT_ROOT" ]; then
    PROJECT_ROOT="$(cd "$BIN_DIR/../../.." && pwd)"
fi
export DDD_ROOT="$PROJECT_ROOT/.ddd"
export PROJECT_ROOT="$PROJECT_ROOT"
echo "Tower: Configured DDD_ROOT=$DDD_ROOT"
echo "Tower: Configured PROJECT_ROOT=$PROJECT_ROOT"

# Check if session exists
tmux has-session -t "$SESSION" 2>/dev/null

if [ $? != 0 ]; then
    echo "Tower: Creating new session '$SESSION'..."
    # Create detached session with environment variable
    # We restart the tmux server environment to be safe or pass via new-session env
    tmux new-session -d -s "$SESSION" "cd '$PROJECT_ROOT' && DDD_ROOT='$DDD_ROOT' PROJECT_ROOT='$PROJECT_ROOT' $DAEMON"
    
    # Launch Watcher in the first window
    # We use 'exec' so the pane doesn't close immediately if daemon exits (though daemon loops)
    # Actually, we want it to stay open.
    tmux send-keys -t "$SESSION:0" "$DAEMON" C-m
    
    echo "Tower: Launched."
else
    echo "Tower: Session '$SESSION' already exists."
fi

# If we are in an interactive SSH session (check TTY), maybe offer to attach?
# For now, just exit success.
exit 0
