#!/bin/bash
# Host Shim: Auto-Bootstraps the Build Environment

# [FIX] Resolve physical location of this script (handles symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
BIN_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

# Paths relative to the REAL binary location
MISSION_ROOT="$(dirname "$BIN_DIR")"
DDD_DIR="$MISSION_ROOT/tools/ddd"
BOOTSTRAP="$DDD_DIR/bootstrap.sh"
VENV="$DDD_DIR/.venv"
TARGET="$DDD_DIR/bin/dd-daemon"

# Validation & Bootstrap
if [ ! -d "$DDD_DIR" ]; then
    echo "❌ Error: DDD toolchain not found in $DDD_DIR"
    exit 1
fi

if [ ! -d "$VENV" ]; then
    echo "⚡️ [DDD] Initializing Build Environment..."
    if [ -f "$BOOTSTRAP" ]; then
        bash "$BOOTSTRAP"
    else
        echo "❌ Error: bootstrap.sh missing."
        exit 1
    fi
fi

exec "$TARGET" "$@"
